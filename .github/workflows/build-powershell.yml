name: Build and Publish PowerShell Module

on:
  push:
    tags:
      - 'ps-v*'
    branches:
      - master
    paths:
      - 'loraxMod-cs/**'
      - 'powershellMod/**'
      - '.github/workflows/build-powershell.yml'
  pull_request:
    paths:
      - 'loraxMod-cs/**'
      - 'powershellMod/**'
  workflow_dispatch:

jobs:
  build:
    name: Build and Test
    runs-on: windows-latest
    # TreeSitter.DotNet only has Windows native DLLs

    steps:
      - uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Restore dependencies
        working-directory: loraxMod-cs
        run: dotnet restore

      - name: Build Release
        working-directory: loraxMod-cs
        run: dotnet build --configuration Release

      - name: Run tests
        working-directory: loraxMod-cs
        run: dotnet test tests/LoraxMod.Tests.csproj --configuration Release --verbosity normal

      - name: Publish to powershellMod/bin
        working-directory: loraxMod-cs
        run: dotnet publish --configuration Release --output ../powershellMod/bin

      - name: Test module import
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          Import-Module ./powershellMod/LoraxMod.psd1 -Verbose
          $cmds = Get-Command -Module LoraxMod
          Write-Host "Loaded $($cmds.Count) commands from LoraxMod"
          if ($cmds.Count -lt 10) { throw "Expected at least 10 cmdlets" }

      - name: Upload module artifact
        uses: actions/upload-artifact@v4
        with:
          name: powershell-module
          path: powershellMod/

  publish:
    name: Publish to PowerShell Gallery
    needs: build
    runs-on: windows-latest
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/ps-v')

    steps:
      - uses: actions/download-artifact@v4
        with:
          name: powershell-module
          path: ./powershellMod

      - name: Debug - List downloaded files
        shell: pwsh
        run: |
          Write-Host "=== Directory structure ==="
          Get-ChildItem -Path . -Recurse -Depth 3 | Select-Object FullName
          Write-Host ""
          Write-Host "=== powershellMod contents ==="
          Get-ChildItem -Path ./powershellMod -Recurse | Select-Object FullName, Length
          Write-Host ""
          Write-Host "=== Check for psd1 file ==="
          $psd1 = Get-ChildItem -Path . -Filter "*.psd1" -Recurse
          Write-Host "Found psd1 files: $($psd1.FullName -join ', ')"

      - name: Validate module manifest
        shell: pwsh
        run: |
          $psd1Path = "./powershellMod/LoraxMod.psd1"
          if (-not (Test-Path $psd1Path)) {
            throw "Module manifest not found at: $psd1Path"
          }
          $dllPath = "./powershellMod/bin/LoraxMod.dll"
          if (-not (Test-Path $dllPath)) {
            throw "RootModule DLL not found at: $dllPath"
          }
          $manifest = Test-ModuleManifest -Path $psd1Path
          Write-Host "Module: $($manifest.Name) v$($manifest.Version)"
          Write-Host "Description: $($manifest.Description)"
          Write-Host "RootModule: $($manifest.RootModule)"

      - name: Publish to PowerShell Gallery
        shell: pwsh
        env:
          POWERSHELL_GALLERY_KEY: ${{ secrets.POWERSHELL_GALLERY }}
        run: |
          $modulePath = Resolve-Path "./powershellMod"
          Write-Host "Publishing from: $modulePath"
          Publish-Module -Path $modulePath -NuGetApiKey $env:POWERSHELL_GALLERY_KEY -Verbose
