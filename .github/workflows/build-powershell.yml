name: Build and Publish PowerShell Module

on:
  push:
    tags:
      - 'ps-v*'
    branches:
      - master
    paths:
      - 'loraxMod-cs/**'
      - 'powershellMod/**'
      - '.github/workflows/build-powershell.yml'
  pull_request:
    paths:
      - 'loraxMod-cs/**'
      - 'powershellMod/**'
  workflow_dispatch:

jobs:
  build:
    name: Build and Test
    runs-on: windows-latest
    # TreeSitter.DotNet only has Windows native DLLs

    steps:
      - uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Restore dependencies
        working-directory: loraxMod-cs
        run: dotnet restore

      - name: Build Release
        working-directory: loraxMod-cs
        run: dotnet build --configuration Release

      - name: Run tests
        working-directory: loraxMod-cs
        run: dotnet test tests/LoraxMod.Tests.csproj --configuration Release --verbosity normal

      - name: Publish to powershellMod/bin
        working-directory: loraxMod-cs
        run: dotnet publish --configuration Release --output ../powershellMod/bin

      - name: Test module import
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          Import-Module ./powershellMod/LoraxMod.psd1 -Verbose
          $cmds = Get-Command -Module LoraxMod
          Write-Host "Loaded $($cmds.Count) commands from LoraxMod"
          if ($cmds.Count -lt 10) { throw "Expected at least 10 cmdlets" }

      - name: Upload module artifact
        uses: actions/upload-artifact@v4
        with:
          name: powershell-module
          path: powershellMod/

  publish:
    name: Publish to PowerShell Gallery
    needs: build
    runs-on: windows-latest
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/ps-v')

    steps:
      - uses: actions/download-artifact@v4
        with:
          name: powershell-module
          path: ./LoraxMod

      - name: Validate module structure
        shell: pwsh
        run: |
          Write-Host "=== Module folder contents ==="
          Get-ChildItem -Path ./LoraxMod -Recurse -Depth 2 | Select-Object FullName

          $psd1Path = "./LoraxMod/LoraxMod.psd1"
          if (-not (Test-Path $psd1Path)) {
            throw "Module manifest not found at: $psd1Path"
          }
          $dllPath = "./LoraxMod/bin/LoraxMod.dll"
          if (-not (Test-Path $dllPath)) {
            throw "RootModule DLL not found at: $dllPath"
          }
          $manifest = Test-ModuleManifest -Path $psd1Path
          Write-Host "Module: $($manifest.Name) v$($manifest.Version)"
          Write-Host "RootModule: $($manifest.RootModule)"

      - name: Publish to PowerShell Gallery
        shell: pwsh
        env:
          POWERSHELL_GALLERY_KEY: ${{ secrets.POWERSHELL_GALLERY }}
        run: |
          $modulePath = Resolve-Path "./LoraxMod"
          Write-Host "Publishing from: $modulePath"
          Publish-Module -Path $modulePath -NuGetApiKey $env:POWERSHELL_GALLERY_KEY -Verbose

  release:
    name: Create GitHub Release
    needs: publish
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/ps-v')
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4

      - uses: actions/download-artifact@v4
        with:
          name: powershell-module
          path: ./LoraxMod

      - name: Create module zip
        run: zip -r LoraxMod-PowerShell.zip LoraxMod/

      - name: Extract version from tag
        id: version
        run: echo "version=${GITHUB_REF#refs/tags/ps-v}" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: "PowerShell v${{ steps.version.outputs.version }}"
          body: |
            ## LoraxMod (PowerShell) v${{ steps.version.outputs.version }}

            Install from PowerShell Gallery:
            ```powershell
            Install-Module LoraxMod -Scope CurrentUser
            ```

            Or download the zip and import manually:
            ```powershell
            Expand-Archive LoraxMod-PowerShell.zip -DestinationPath $env:PSModulePath.Split(';')[0]
            Import-Module LoraxMod
            ```

            See [Release Notes](https://github.com/${{ github.repository }}/blob/master/powershellMod/LoraxMod.psd1) for details.
          files: LoraxMod-PowerShell.zip
          draft: false
          prerelease: false
